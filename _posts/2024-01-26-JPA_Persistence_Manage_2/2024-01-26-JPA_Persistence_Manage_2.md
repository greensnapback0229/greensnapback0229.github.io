---
categories: [JPA, Persistence]
tags: [Persistence, 영속성]
---

### Flush의 동작
`Flush()`는 영속성 컨택스의 변경 내용을 DB에 반영하는 과정이다. 

[구체적 과정]
1. 영속성 컨택스트에 있는 모든 엔티티를 스냅샷과 비교해서 다른 엔티티를 찾고 이를 가지고 수정 쿼리(SQL)을 만들어서 쓰기 지연 SQL 저장소에 등록한다. 
2. 쓰기 지연 SQL 저장소의 쿼리를 데이터베이스에 전송한다. 

영속성 컨택스트를 플러시하는 방법
- `em.flush()`를 직접 호출(테스트 or 다른 프레임워크 JPA를 혼합사용 아닌이상 사용 잘 안함)
- 트랜잭션 커밋시 자동 호출
- JPQL쿼리시 자동 호출 

### 플러시모드

| 옵션명               | 동작                             |
|----------------------|---------------------------------|
| `FlsuhModeType.AUTO`   | 커밋이나 쿼리를 실행할 때 플러시 |
| `FlushModeType.COMMIT` | 커밋할 때만 플러시              |

기본적으로 `AUTO`로 동작하고 트랜잭션 커밋이나 쿼리실행시에 플러시를 자동으로 호출한다. 

<blockquote class="prompt-warning">
플러시는 영속성 컨택스트에 보관된 엔티티를 지우는 것이 아니라 DB에 동기화하는 것이다.
</blockquote>

## 준영속
준영속(`detach`)상태이 엔티티는 영속성 컨텍스트가 제공하는 기능을 사용할 수 없다.

**준영속 상태로 만드는 방법**
1. em.detach(entity) 특정 엔티티만 준영속 상태로 전환한다. 
2. em.clear() 영속성 컨택스트를 완전히 초기화한다 
3. em.close() 영속성 컨텍스트를 종료한다. 

**준영속 상태 특징**
- 1차 캐시, 쓰기 지연 등등 영속성 컨택스트가 제공하는 기능이 동작할 수 없다. 

- 식별자 값을 가지고는 있다. 

- 지연 로딩(`Lazy Loading`)을 할 수 없다. 

**병합**
준영속 상태를 다시 영속상태로 만드려면 `merge()`를 사용하면 된다. 
